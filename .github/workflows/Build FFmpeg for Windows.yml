name: Build FFmpeg for Windows

on:
  workflow_dispatch:

jobs:
  build:
    name: Windows
    runs-on: windows-latest
    steps:
      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-iconv
            zip
            nasm
            mingw-w64-x86_64-cmake
            git

      - name: Download FFmpeg source
        run: |
          git clone https://git.ffmpeg.org/ffmpeg.git ffmpeg --depth 1

      - name: Clone & Build whisper.cpp
        shell: msys2 {0}
        run: |
          set -euo pipefail
          PREFIX=/usr/local
          git clone --depth 1 https://github.com/ggerganov/whisper.cpp.git
          cd whisper.cpp
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX="${PREFIX}" \
                -DWHISPER_BUILD_TESTS=OFF \
                -DWHISPER_BUILD_EXAMPLES=OFF \
                -DWHISPER_BUILD_SHARED_LIB=OFF \
                -DGGML_SHARED=OFF \
                -DGGML_OPENMP=ON \
                -DWHISPER_NO_ACCELERATE=ON \
                -DBUILD_SHARED_LIBS=OFF \
                ..
          cmake --build . --config Release -j $(nproc)
          cmake --install .
          cd "${PREFIX}/lib"
          if [ -f ggml.a ] && [ ! -f libggml.a ]; then mv ggml.a libggml.a; fi
          for f in ggml-*.a; do [ -f "$f" ] && [ ! -f "lib$f" ] && mv "$f" "lib$f" || true; done
          mkdir -p "${PREFIX}/lib/pkgconfig"
          cat > "${PREFIX}/lib/pkgconfig/whisper.pc" << 'EOF'
          prefix=/usr/local
          exec_prefix=${prefix}
          libdir=${exec_prefix}/lib
          includedir=${prefix}/include

          Name: whisper
          Description: Port of OpenAI's Whisper model in C/C++
          Version: 1.8.0
          Libs: -L${libdir} -lwhisper -lggml -lggml-cpu -lggml-base -lgomp
          Libs.private: -lstdc++ -lm -lpthread -lgomp
          Cflags: -I${includedir} -fopenmp
          EOF
          cp "${PREFIX}/lib/pkgconfig/whisper.pc" "${PREFIX}/lib/pkgconfig/libwhisper.pc" || true

      - name: Configure FFmpeg
        shell: msys2 {0}
        run: |
          set -euo pipefail
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
          pkg-config --exists whisper || (echo 'whisper.pc missing' && exit 1)
          echo "whisper version: $(pkg-config --modversion whisper)"
          cat > test.c <<'EOF'
          #include <whisper.h>
          int main(void) {
              (void) whisper_init_from_file_with_params;
              return 0;
          }
          EOF
          g++ $(pkg-config --cflags whisper) test.c $(pkg-config --libs whisper) -o /tmp/t || (echo 'link fail' && exit 1)
          rm -f test.c /tmp/t
          cd ffmpeg
          ./configure --disable-everything \
            --enable-static --disable-shared \
            --disable-ffprobe --enable-ffmpeg \
            --enable-avcodec --enable-avformat --enable-avutil --enable-avfilter --enable-swresample \
            --enable-protocol=file \
            --enable-whisper --enable-filter=whisper \
            --enable-decoder=srt --enable-decoder=movtext --enable-decoder=webvtt \
            --enable-decoder=ass --enable-decoder=ssa --enable-decoder=subrip \
            --enable-encoder=srt --enable-encoder=subrip --enable-encoder=movtext \
            --enable-demuxer=mov --enable-demuxer=matroska --enable-demuxer=ass \
            --enable-demuxer=srt --enable-demuxer=webvtt \
            --enable-demuxer=wav --enable-demuxer=mp3 --enable-demuxer=aac \
            --enable-decoder=pcm_s16le --enable-decoder=mp3 --enable-decoder=aac \
            --enable-muxer=srt \
            --pkg-config-flags="--static" \
            --extra-cflags="-I/usr/local/include" \
            --extra-ldflags="-L/usr/local/lib"
          make -j$(nproc)
          make install

      - name: Smoke Test
        shell: msys2 {0}
        run: |
          /usr/local/bin/ffmpeg.exe -hide_banner -filters | grep -i whisper || (echo 'Whisper filter missing' && exit 1)
          /usr/local/bin/ffmpeg.exe -hide_banner -encoders | grep -E 'subrip' || echo 'subrip encoder missing'

      - name: Package Artifact
        shell: msys2 {0}
        run: |
          DEST=/usr/local/bin/ffmpeg-build
          mkdir -p "$DEST"
          cp /usr/local/bin/ffmpeg.exe "$DEST/"
          # Core runtime deps (some already mostly static but ensure presence)
          cp /mingw64/bin/libbz2-1.dll "$DEST/" || true
          cp /mingw64/bin/libiconv-2.dll "$DEST/" || true
          cp /mingw64/bin/liblzma-5.dll "$DEST/" || true
          cp /mingw64/bin/libwinpthread-1.dll "$DEST/" || true
          cp /mingw64/bin/zlib1.dll "$DEST/" || true
          # OpenMP / GCC C++ runtime dependencies
          cp /mingw64/bin/libgomp-1.dll "$DEST/" || true
          cp /mingw64/bin/libstdc++-6.dll "$DEST/" || true
          cp /mingw64/bin/libgcc_s_seh-1.dll "$DEST/" || true
          cp /mingw64/bin/libssp-0.dll "$DEST/" || true
          # Do not distribute whisper.pc â€“ not needed at runtime
          cat > "$DEST/README-whisper.txt" << 'R'
          FFmpeg + whisper filter (static build)

          This artifact contains:
            - ffmpeg.exe (linked with whisper/ggml; OpenMP enabled)
            - required runtime DLLs (C++ runtime, OpenMP, compression libs)

          The pkg-config file (whisper.pc) is NOT included because it only
          matters when compiling software against libwhisper. End users do not need it.

          Usage example:
            ffmpeg -i input.wav -filter:a "whisper=model=ggml-tiny.en.bin:task=transcribe" -f null -

          Optional performance tuning:
            set OMP_NUM_THREADS=6   (Windows CMD)
            $env:OMP_NUM_THREADS=6  (PowerShell)

          Build flags summary:
            --enable-whisper --enable-filter=whisper (OpenMP enabled)
          R

      - name: Verify Packaged FFmpeg Runs
        shell: msys2 {0}
        run: |
          DEST=/usr/local/bin/ffmpeg-build
          echo "Verifying runtime dependencies in $DEST";
          ls -1 "$DEST"
          "$DEST/ffmpeg.exe" -hide_banner -version || (echo 'Packaged ffmpeg failed to run (likely missing DLL).' && exit 1)

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows
          path: D:\a\_temp\msys64\usr\local\bin\ffmpeg-build
